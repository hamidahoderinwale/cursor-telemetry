<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Privacy Analysis - PKL Dashboard</title>
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <link rel="stylesheet" href="/assets/css/variables.css">
    <link rel="stylesheet" href="/assets/css/main-refactored.css">
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
        .privacy-dashboard {
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .privacy-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #e5e7eb;
        }
        
        .privacy-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .privacy-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .privacy-card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .privacy-metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }
        
        .metric-card {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            padding: 15px;
            text-align: center;
        }
        
        .metric-value {
            font-size: 24px;
            font-weight: bold;
            color: #1e40af;
        }
        
        .metric-label {
            font-size: 14px;
            color: #64748b;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="privacy-dashboard">
        <div class="privacy-header">
            <div>
                <h1>Privacy Analysis Dashboard</h1>
                <p>Analyze privacy implications and data transformations in your coding sessions</p>
            </div>
            <div class="privacy-controls">
                <button class="btn btn-secondary" onclick="window.location.href='/'">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M19 12H5M12 19l-7-7 7-7"></path>
                    </svg>
                    Back to Main
                </button>
                <button class="btn btn-primary" id="analyze-btn">Run Analysis</button>
                <button class="btn btn-secondary" id="export-btn">Export Report</button>
            </div>
        </div>

        <div class="privacy-metrics">
            <div class="metric-card">
                <div class="metric-value" id="total-sessions">0</div>
                <div class="metric-label">Total Sessions</div>
            </div>
            <div class="metric-card">
                <div class="metric-value" id="privacy-violations">0</div>
                <div class="metric-label">Privacy Violations</div>
            </div>
            <div class="metric-card">
                <div class="metric-value" id="redaction-rate">0%</div>
                <div class="metric-label">Redaction Rate</div>
            </div>
            <div class="metric-card">
                <div class="metric-value" id="expression-score">0.0</div>
                <div class="metric-label">Expression Score</div>
            </div>
        </div>

        <div class="privacy-grid">
            <div class="privacy-card">
                <h3>Privacy Configuration</h3>
                <div id="privacy-config">
                    <p>Loading privacy configuration...</p>
                </div>
            </div>
            
            <div class="privacy-card">
                <h3>Transformation Summary</h3>
                <div id="transformation-summary">
                    <p>No analysis performed yet. Click "Run Analysis" to begin.</p>
                </div>
            </div>
        </div>

        <div class="privacy-card">
            <h3>Privacy Analysis Results</h3>
            <div id="privacy-results">
                <p>Run an analysis to see detailed privacy insights and recommendations.</p>
            </div>
        </div>
    </div>

    <script>
        // Privacy Analysis Dashboard JavaScript
        document.addEventListener('DOMContentLoaded', function() {
            initializePrivacyDashboard();
        });

        function initializePrivacyDashboard() {
            // Load initial privacy stats
            loadPrivacyStats();
            
            // Set up event listeners
            document.getElementById('analyze-btn').addEventListener('click', runPrivacyAnalysis);
            document.getElementById('export-btn').addEventListener('click', exportPrivacyReport);
        }

        async function loadPrivacyStats() {
            try {
                const response = await fetch('/api/privacy/stats');
                const data = await response.json();
                
                if (data.success) {
                    updatePrivacyMetrics(data.stats);
                    updatePrivacyConfig(data.privacyConfig);
                }
            } catch (error) {
                console.error('Error loading privacy stats:', error);
            }
        }

        function updatePrivacyMetrics(stats) {
            document.getElementById('total-sessions').textContent = stats.totalSessions || 0;
            document.getElementById('privacy-violations').textContent = stats.privacyViolations || 0;
            document.getElementById('redaction-rate').textContent = (stats.avgRedactionRate * 100).toFixed(1) + '%';
            document.getElementById('expression-score').textContent = stats.avgExpressionScore?.toFixed(2) || '0.00';
        }

        function updatePrivacyConfig(config) {
            const configDiv = document.getElementById('privacy-config');
            configDiv.innerHTML = `
                <div style="display: grid; gap: 10px;">
                    <div><strong>Epsilon (Privacy Budget):</strong> ${config.epsilon || 'Not set'}</div>
                    <div><strong>Redaction Level:</strong> ${config.redactionLevel || 'Medium'}</div>
                    <div><strong>Anonymization:</strong> ${config.anonymization ? 'Enabled' : 'Disabled'}</div>
                    <div><strong>Data Retention:</strong> ${config.dataRetention || '30 days'}</div>
                </div>
            `;
        }

        async function runPrivacyAnalysis() {
            const analyzeBtn = document.getElementById('analyze-btn');
            analyzeBtn.textContent = 'Analyzing...';
            analyzeBtn.disabled = true;

            try {
                const response = await fetch('/api/privacy/analyze', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        config: {
                            epsilon: 1.0,
                            redactionLevel: 0.7,
                            anonymization: true,
                            dataRetention: '30 days'
                        }
                    })
                });

                const data = await response.json();
                
                if (data.success) {
                    displayPrivacyResults(data);
                    updateTransformationSummary(data);
                } else {
                    throw new Error(data.error || 'Analysis failed');
                }
            } catch (error) {
                console.error('Error running privacy analysis:', error);
                alert('Error running privacy analysis: ' + error.message);
            } finally {
                analyzeBtn.textContent = 'Run Analysis';
                analyzeBtn.disabled = false;
            }
        }

        function displayPrivacyResults(data) {
            const resultsDiv = document.getElementById('privacy-results');
            resultsDiv.innerHTML = `
                <div style="display: grid; gap: 20px;">
                    <div>
                        <h4>Expressiveness Metrics</h4>
                        <p><strong>Overall Score:</strong> ${data.expressivenessMetrics?.expressivenessScore?.toFixed(3) || 'N/A'}</p>
                        <p><strong>Information Loss:</strong> ${data.expressivenessMetrics?.informationLoss?.toFixed(3) || 'N/A'}</p>
                        <p><strong>Privacy Gain:</strong> ${data.expressivenessMetrics?.privacyGain?.toFixed(3) || 'N/A'}</p>
                    </div>
                    <div>
                        <h4>Analysis Summary</h4>
                        <p>Analyzed ${data.originalWorkflows?.length || 0} workflows</p>
                        <p>Generated ${data.transformedWorkflows?.length || 0} privacy-transformed workflows</p>
                        <p>Privacy budget used: ${data.privacyConfig?.epsilon || 'N/A'}</p>
                    </div>
                </div>
            `;
        }

        function updateTransformationSummary(data) {
            const summaryDiv = document.getElementById('transformation-summary');
            summaryDiv.innerHTML = `
                <div style="display: grid; gap: 10px;">
                    <div><strong>Workflows Analyzed:</strong> ${data.originalWorkflows?.length || 0}</div>
                    <div><strong>Transformations Applied:</strong> ${data.transformedWorkflows?.length || 0}</div>
                    <div><strong>Privacy Level:</strong> ${data.privacyConfig?.redactionLevel || 'Medium'}</div>
                    <div><strong>Anonymization:</strong> ${data.privacyConfig?.anonymization ? 'Enabled' : 'Disabled'}</div>
                </div>
            `;
        }

        async function exportPrivacyReport() {
            try {
                const response = await fetch('/api/privacy/export', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        format: 'json',
                        options: {
                            includeWorkflows: true,
                            includeTransformed: true,
                            includeMetrics: true
                        }
                    })
                });

                const data = await response.json();
                
                if (data.success) {
                    // Create download link
                    const link = document.createElement('a');
                    link.href = `/api/export/download/${data.filename}`;
                    link.download = data.filename;
                    link.click();
                } else {
                    throw new Error(data.error || 'Export failed');
                }
            } catch (error) {
                console.error('Error exporting privacy report:', error);
                alert('Error exporting privacy report: ' + error.message);
            }
        }
    </script>
</body>
</html>
