<!DOCTYPE html>
<html>
<head>
    <title>Debug SPA</title>
    <script src="https://unpkg.com/dexie@latest/dist/dexie.js"></script>
</head>
<body>
    <h1>Debug SPA</h1>
    <div id="log"></div>
    
    <script>
        function log(message) {
            const logDiv = document.getElementById('log');
            logDiv.innerHTML += `<div>${new Date().toISOString()}: ${message}</div>`;
            console.log(message);
        }
        
        async function testCompanionConnection() {
            log('üîÑ Testing companion connection...');
            
            try {
                const response = await fetch('http://127.0.0.1:43917/health');
                const data = await response.json();
                log(`‚úÖ Health check successful: ${data.status} (${data.entries} entries, ${data.events} events)`);
                
                // Test queue
                const queueResponse = await fetch('http://127.0.0.1:43917/queue?since=1970-01-01T00:00:00.000Z');
                const queueData = await queueResponse.json();
                log(`‚úÖ Queue check successful: ${queueData.entries.length} entries, ${queueData.events.length} events`);
                
                // Test database
                const db = new Dexie('TestDB');
                db.version(1).stores({
                    entries: '++id, session_id, timestamp, source, file_path',
                    events: '++id, session_id, timestamp, type'
                });
                
                await db.open();
                log('‚úÖ Database opened successfully');
                
                // Try to add a test entry
                const testEntry = {
                    id: 'test-' + Date.now(),
                    session_id: 'test-session',
                    timestamp: new Date().toISOString(),
                    source: 'test',
                    file_path: 'test.txt'
                };
                
                const entryId = await db.entries.add(testEntry);
                log(`‚úÖ Test entry added with ID: ${entryId}`);
                
                // Try to add companion entries
                for (const entry of queueData.entries) {
                    try {
                        await db.entries.add(entry);
                        log(`‚úÖ Added companion entry: ${entry.id}`);
                    } catch (error) {
                        log(`‚ùå Error adding entry ${entry.id}: ${error.message}`);
                    }
                }
                
                // Count total entries
                const totalEntries = await db.entries.count();
                log(`üìä Total entries in database: ${totalEntries}`);
                
            } catch (error) {
                log(`‚ùå Error: ${error.message}`);
                log(`‚ùå Stack: ${error.stack}`);
            }
        }
        
        // Start test
        testCompanionConnection();
    </script>
</body>
</html>
