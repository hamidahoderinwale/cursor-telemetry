<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cursor Activity Dashboard</title>
  
  <!-- Styles -->
  <link rel="stylesheet" href="dashboard.css">
  
  <!-- View-specific Styles (co-located with JS) -->
  <link rel="stylesheet" href="views/navigator/styles.css">
  <link rel="stylesheet" href="views/activity/styles.css">
  <link rel="stylesheet" href="views/analytics/styles.css">
  <link rel="stylesheet" href="views/overview/styles.css">
  <link rel="stylesheet" href="views/system/styles.css">
  <link rel="stylesheet" href="views/file-graph/styles.css">
  
  <!-- Service Worker Registration -->
  <script>
    // Option to disable ServiceWorker if causing CORS issues
    // Set to true to disable (useful for debugging OpaqueResponseBlocking errors)
    const DISABLE_SERVICE_WORKER = false;
    
    if (!DISABLE_SERVICE_WORKER && 'serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        // Unregister any existing service workers first
        navigator.serviceWorker.getRegistrations().then(registrations => {
          registrations.forEach(registration => {
            registration.unregister().then(() => {
              console.log('[SW] Unregistered old service worker');
            });
          });
        });
        
        // Register new service worker
        navigator.serviceWorker.register('/sw.js')
          .then(reg => {
            console.log('[SW] Registered:', reg.scope);
            // Check for updates
            reg.addEventListener('updatefound', () => {
              console.log('[SW] Update found, reloading...');
              window.location.reload();
            });
          })
          .catch(err => {
            console.warn('[SW] Registration failed:', err);
            console.warn('[SW] If you see OpaqueResponseBlocking errors, set DISABLE_SERVICE_WORKER = true');
          });
      });
    } else if (DISABLE_SERVICE_WORKER) {
      console.log('[SW] ServiceWorker disabled (DISABLE_SERVICE_WORKER = true)');
      // Unregister any existing service workers
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.getRegistrations().then(registrations => {
          registrations.forEach(registration => registration.unregister());
        });
      }
    }
  </script>
</head>
<body>
  <!-- Main App Container -->
  <div id="app" class="app-container">
    
    <!-- Status Popup -->
    <div id="statusPopup" class="status-popup">
      <div class="status-popup-header">
        <span class="status-popup-title">[LAUNCH] Dashboard Status</span>
        <button class="status-popup-close" onclick="closeStatusPopup()">×</button>
      </div>
      <div class="status-popup-content" id="statusPopupContent">
        <div class="status-message">Initializing...</div>
      </div>
    </div>

    <!-- Sidebar Navigation -->
    <aside class="sidebar">
      <div class="sidebar-header">
        <div class="logo">
          <svg width="32" height="32" viewBox="0 0 32 32" fill="none">
            <path d="M16 8L24 16L16 24L8 16L16 8Z" fill="url(#gradient)" opacity="0.9"/>
            <defs>
              <linearGradient id="gradient" x1="0" y1="0" x2="32" y2="32">
                <stop offset="0%" stop-color="#8B5CF6"/>
                <stop offset="100%" stop-color="#6366F1"/>
              </linearGradient>
            </defs>
          </svg>
          <span>Cursor Activity</span>
        </div>
        <button class="search-trigger" onclick="openSearchPalette()" title="Search (Cmd+K)">
          <svg width="18" height="18" viewBox="0 0 20 20" fill="none" stroke="currentColor">
            <circle cx="8" cy="8" r="6" stroke-width="2"/>
            <path d="M13 13l4 4" stroke-width="2" stroke-linecap="round"/>
          </svg>
          <kbd class="search-trigger-kbd">⌘K</kbd>
        </button>
      </div>

      <div style="padding: 0 var(--space-lg); margin-top: var(--space-sm); margin-bottom: var(--space-md);">
        <div class="connection-status" id="connectionStatus">
          <div class="connection-status-row">
            <span class="status-dot"></span>
            <span class="status-text">Connecting...</span>
          </div>
          <div class="connection-progress" id="connectionProgress">
            <div class="connection-progress-bar" id="connectionProgressBar" style="width: 0%"></div>
          </div>
        </div>
      </div>

      <nav class="sidebar-nav">
        <a href="#overview" class="nav-link active" data-view="overview">
          <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
            <path d="M3 4a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1V4zM3 10a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H4a1 1 0 01-1-1v-6zM14 9a1 1 0 00-1 1v6a1 1 0 001 1h2a1 1 0 001-1v-6a1 1 0 00-1-1h-2z"/>
          </svg>
          <span>Overview</span>
        </a>
        
        <a href="#activity" class="nav-link" data-view="activity">
          <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z"/>
          </svg>
          <span>Activity</span>
        </a>
        
        <a href="#analytics" class="nav-link" data-view="analytics">
          <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
            <path d="M2 11a1 1 0 011-1h2a1 1 0 011 1v5a1 1 0 01-1 1H3a1 1 0 01-1-1v-5zM8 7a1 1 0 011-1h2a1 1 0 011 1v9a1 1 0 01-1 1H9a1 1 0 01-1-1V7zM14 4a1 1 0 011-1h2a1 1 0 011 1v12a1 1 0 01-1 1h-2a1 1 0 01-1-1V4z"/>
          </svg>
          <span>Analytics</span>
        </a>
        
        <a href="#filegraph" class="nav-link" data-view="filegraph">
          <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
            <path d="M10 3.5a1.5 1.5 0 013 0V4a1 1 0 001 1h3a1 1 0 011 1v3a1 1 0 01-1 1h-.5a1.5 1.5 0 000 3h.5a1 1 0 011 1v3a1 1 0 01-1 1h-3a1 1 0 01-1-1v-.5a1.5 1.5 0 00-3 0v.5a1 1 0 01-1 1H6a1 1 0 01-1-1v-3a1 1 0 00-1-1h-.5a1.5 1.5 0 010-3H4a1 1 0 001-1V6a1 1 0 011-1h3a1 1 0 001-1v-.5z"/>
          </svg>
          <span>File Graph</span>
        </a>

        <a href="#navigator" class="nav-link" data-view="navigator">
          <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd"/>
          </svg>
          <span>Navigator</span>
        </a>
        
        <a href="#system" class="nav-link" data-view="system">
          <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd" d="M11.49 3.17c-.38-1.56-2.6-1.56-2.98 0a1.532 1.532 0 01-2.286.948c-1.372-.836-2.942.734-2.106 2.106.54.886.061 2.042-.947 2.287-1.561.379-1.561 2.6 0 2.978a1.532 1.532 0 01.947 2.287c-.836 1.372.734 2.942 2.106 2.106a1.532 1.532 0 012.287.947c.379 1.561 2.6 1.561 2.978 0a1.533 1.533 0 012.287-.947c1.372.836 2.942-.734 2.106-2.106a1.533 1.533 0 01.947-2.287c1.561-.379 1.561-2.6 0-2.978a1.532 1.532 0 01-.947-2.287c.836-1.372-.734-2.942-2.106-2.106a1.532 1.532 0 01-2.287-.947zM10 13a3 3 0 100-6 3 3 0 000 6z"/>
          </svg>
          <span>System</span>
        </a>
        
        <a href="#api-docs" class="nav-link" data-view="api-docs">
          <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
            <path d="M9 4.804A7.968 7.968 0 005.5 4c-1.255 0-2.443.29-3.5.804v10A7.969 7.969 0 015.5 14c1.669 0 3.218.51 4.5 1.385A7.962 7.962 0 0114.5 14c1.255 0 2.443.29 3.5.804v-10A7.968 7.968 0 0014.5 4c-1.255 0-2.443.29-3.5.804V12a1 1 0 11-2 0V4.804z"/>
          </svg>
          <span>API Docs</span>
        </a>
      </nav>

      <div class="sidebar-footer">
        <div class="workspace-selector">
          <label>Workspace</label>
          <select id="workspaceSelect" class="select-input">
            <option value="all">All Workspaces</option>
          </select>
        </div>
        
        <button class="export-btn" onclick="showExportOptionsModal()" title="Export database with custom options (date range, types, filters)">
          <svg width="18" height="18" viewBox="0 0 20 20" fill="currentColor">
            <path d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z"/>
          </svg>
          <span>Export JSON</span>
        </button>
      </div>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
      <!-- Header Stats -->
      <header class="dashboard-header">
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-content">
              <span class="stat-label" title="Unique coding sessions detected">Active Sessions</span>
              <span class="stat-value" id="statSessions">0</span>
            </div>
          </div>
          <div class="stat-card">
            <div class="stat-content">
              <span class="stat-label" title="Total file changes tracked (all-time)">File Changes</span>
              <span class="stat-value" id="statFileChanges">0</span>
            </div>
          </div>
          <div class="stat-card">
            <div class="stat-content">
              <span class="stat-label" title="Prompts with meaningful content (>5 chars). Includes: Cursor chat, Composer, manual capture, clipboard. Excludes: empty prompts, JSON metadata, system messages. Checks all text fields: text, prompt, preview, content, message.">AI Interactions</span>
              <span class="stat-value" id="statAIInteractions">0</span>
            </div>
          </div>
          <div class="stat-card">
            <div class="stat-content">
              <span class="stat-label" title="Total code added + deleted (all-time)">Code Changed</span>
              <span class="stat-value" id="statCodeChanged">0 KB</span>
            </div>
          </div>
          <div class="stat-card">
            <div class="stat-content">
              <span class="stat-label" title="Average AI context window utilization">Avg Context Used</span>
              <span class="stat-value" id="statAvgContext">0%</span>
            </div>
          </div>
        </div>
      </header>

      <!-- View Container -->
      <div id="viewContainer" class="view-container">
        <!-- Views will be rendered here -->
      </div>
    </main>
  </div>

  <!-- Event Modal -->
  <div id="eventModal" class="modal">
    <div class="modal-overlay"></div>
    <div class="modal-content modal-large">
      <div class="modal-header">
        <h2 id="modalTitle">Event Details</h2>
        <button class="modal-close" onclick="closeEventModal()">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <path d="M18 6L6 18M6 6l12 12" stroke-width="2" stroke-linecap="round"/>
          </svg>
        </button>
      </div>
      <div class="modal-body" id="modalBody">
        <!-- Modal content -->
      </div>
    </div>
  </div>

  <!-- Thread Modal -->
  <div id="threadModal" class="modal">
    <div class="modal-overlay"></div>
    <div class="modal-content modal-large">
      <div class="modal-header">
        <h2 id="threadModalTitle">Thread Details</h2>
        <button class="modal-close" onclick="closeThreadModal()">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <path d="M18 6L6 18M6 6l12 12" stroke-width="2" stroke-linecap="round"/>
          </svg>
        </button>
      </div>
      <div class="modal-body" id="threadModalBody">
        <!-- Thread content -->
      </div>
    </div>
  </div>

  <!-- Search Command Palette -->
  <div id="searchPalette" class="search-palette">
    <div class="search-palette-overlay" onclick="closeSearchPalette()"></div>
    <div class="search-palette-content">
      <div class="search-palette-header">
        <div class="search-input-wrapper">
          <svg class="search-icon" width="20" height="20" viewBox="0 0 20 20" fill="none" stroke="currentColor">
            <circle cx="8" cy="8" r="6" stroke-width="2"/>
            <path d="M13 13l4 4" stroke-width="2" stroke-linecap="round"/>
          </svg>
          <input 
            type="text" 
            id="searchInput" 
            class="search-input" 
            placeholder="Search events, prompts, files... (try 'type:prompt' or 'date:today')"
            autocomplete="off"
            spellcheck="false"
          />
          <kbd class="search-kbd">esc</kbd>
        </div>
      </div>
      <div class="search-palette-body">
        <div id="searchResults" class="search-results">
          <!-- Results will be rendered here -->
        </div>
        <div id="searchSuggestions" class="search-suggestions">
          <!-- Suggestions will be rendered here -->
        </div>
      </div>
      <div class="search-palette-footer">
        <div class="search-hint">
          <span><kbd>↑</kbd><kbd>↓</kbd> navigate</span>
          <span><kbd>↵</kbd> select</span>
          <span><kbd>esc</kbd> close</span>
        </div>
        <div class="search-filters">
          <span class="search-filter-hint">Filters: <code>type:</code> <code>workspace:</code> <code>date:</code> <code>mode:</code></span>
        </div>
      </div>
    </div>
  </div>

  <!-- Chat Widget -->
  <div id="chatWidget"></div>

  <script>
    // Initialize chat widget
    fetch('widgets/chat-widget.html')
      .then(response => response.text())
      .then(html => {
        document.getElementById('chatWidget').innerHTML = html;
        if (window.initChatWidget) {
          window.initChatWidget();
        }
      })
      .catch(err => console.warn('Chat widget not loaded:', err));
  </script>
  
  <!-- External Libraries -->
  <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <script src="https://unpkg.com/lunr/lunr.js"></script>
  
  <!-- Core Modules -->
  <script src="core/config.js"></script>
  <script src="core/state.js"></script>
  <script src="core/api-client.js"></script>
  <script src="core/websocket-manager.js"></script>
  
  <!-- Algorithm Modules -->
  <script type="module" src="algorithms/similarity.js"></script>
  <script type="module" src="algorithms/dimensionality-reduction.js"></script>
  <script type="module" src="algorithms/clustering.js"></script>
  
  <!-- UI Modules -->
  <script type="module" src="modals/modal-manager.js"></script>
  
  <!-- Utilities (load first - no dependencies) -->
  <script src="utils/helpers.js"></script>
  <script src="utils/file-helpers.js"></script>
  <script src="utils/math-helpers.js"></script>
  <script src="utils/data-helpers.js"></script>
  <script src="utils/time-formatting.js"></script>
  <script src="utils/event-helpers.js"></script>
  <script src="utils/temporal-threading.js"></script>
  <script src="utils/event-tagging.js"></script>
  <script src="utils/templates.js"></script>
  <script src="utils/export-options-modal.js"></script>
  
  <!-- Views (must load before view-router) -->
  <script src="views/activity/timeline-helpers.js"></script>
  <script src="views/activity/search-handler.js"></script>
  <script src="views/activity/grouping-handler.js"></script>
  <script src="views/overview/helpers.js"></script>
  <script src="views/overview/heatmap.js"></script>
  <script src="views/overview/index.js"></script>
  <script src="views/activity/index.js"></script>
  <script src="views/threads/helpers.js"></script>
  <script src="views/threads/index.js"></script>
  <script src="views/analytics/chart-helpers.js"></script>
  <script src="views/analytics/index.js"></script>
  <script src="views/system/templates.js"></script>
  <script src="views/system/index.js"></script>
  <script src="views/file-graph/templates.js"></script>
  <script src="views/file-graph/tfidf-analyzer.js"></script>
  <script src="views/file-graph/embeddings-visualization.js"></script>
  <script src="views/file-graph/helpers.js"></script>
  <script src="views/file-graph/d3-renderer.js"></script>
  <script src="views/file-graph/file-graph.js"></script>
  <script src="views/file-graph/index.js"></script>
  <script src="views/navigator/templates.js"></script>
  <script src="views/navigator/navigator-layout.js"></script>
  <script src="views/navigator/navigator-renderer.js"></script>
  <script src="views/navigator/navigator-core.js"></script>
  <script src="views/navigator/index.js"></script>
  <script src="views/api-docs/templates.js"></script>
  <script src="views/api-docs/index.js"></script>
  
  <!-- View Router (loads after all views) -->
  <script src="core/view-router.js"></script>
  
  <!-- Components -->
  <script src="components/charts/chart-utils.js"></script>
  <script type="module" src="components/charts/chart-renderers.js"></script>
  <script type="module" src="components/charts/analytics-renderers.js"></script>
  
  <!-- Services: Data -->
  <script src="services/data/persistent-storage.js"></script>
  <script src="services/data/data-synchronizer.js"></script>
  
  <!-- Services: Search (load before app/search-handler.js) -->
  <script src="services/search/search-engine.js"></script>
  <script src="services/search/semantic-analysis-engine.js"></script>
  
  <!-- Services: Analytics -->
  <script src="services/analytics/analytics-manager.js"></script>
  <script src="services/analytics/analytics-aggregator.js"></script>
  <script src="services/analytics/prompt-analytics-engine.js"></script>
  
    <!-- App Modules -->
    <script src="app/progress-tracker.js"></script>
    <script src="app/status-popup.js"></script>
    <script src="app/export-handler.js"></script>
    <script src="app/search-handler.js"></script>
    <script src="app/ui-helpers.js"></script>
    <script src="app/data-initializer.js"></script>
  
  <!-- Utilities -->
  <script src="utils/dashboard-helpers.js"></script>
  
  <!-- Config & Main Dashboard -->
  <script src="config.js"></script>
  <script src="dashboard.js"></script>
  
  <!-- Visualizations -->
  <script src="visualizations/file-graph-visualizer.js"></script>
  <script src="visualizations/time-series-visualizer.js"></script>
  
  <!-- Widgets -->
  <script src="widgets/chat-widget.js"></script>
  <script src="widgets/prompt-display-system.js"></script>
</body>
</html>
