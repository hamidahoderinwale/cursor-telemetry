<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cursor Telemetry Dashboard</title>
  
  <!-- Favicon (Seedling emoji ) -->
  <link rel="icon" type="image/svg+xml" href="/favicon.svg">
  <link rel="apple-touch-icon" href="/favicon.svg">
  <link rel="icon" type="image/x-icon" href="/favicon.ico">
  
  <!-- Fonts -->
  <!-- Load Geist Sans and Geist Mono from Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Geist+Sans:wght@100..900&family=Geist+Mono:wght@100..900&display=swap" rel="stylesheet" media="print" onload="this.media='all'">
  <noscript><link href="https://fonts.googleapis.com/css2?family=Geist+Sans:wght@100..900&family=Geist+Mono:wght@100..900&display=swap" rel="stylesheet"></noscript>
  
  <!-- Preload optimized bundles - Critical path -->
  <link rel="preload" href="dashboard.css" as="style">
  <link rel="preload" href="dist/critical.bundle.js" as="script">
  <link rel="preload" href="dist/performance.bundle.js" as="script">
  <link rel="preload" href="dist/data-services.bundle.js" as="script">
  <link rel="preload" href="lib/vendor/chart.min.js" as="script">
  <link rel="preload" href="lib/vendor/d3.min.js" as="script">
  
  <!-- Prefetch likely next resources -->
  <link rel="prefetch" href="views/activity/index.js">
  <link rel="prefetch" href="core/view-router.js">
  
  <!-- DNS prefetch for external resources -->
  <link rel="dns-prefetch" href="https://fonts.googleapis.com">
  <link rel="dns-prefetch" href="https://fonts.gstatic.com">
  <link rel="dns-prefetch" href="https://cdn.jsdelivr.net">
  <link rel="dns-prefetch" href="https://cdn.socket.io">
  <!-- D3.js now self-hosted -->
  <link rel="dns-prefetch" href="https://cdn.jsdelivr.net">
  
  <!-- Critical CSS (inline or load immediately) -->
  <link rel="stylesheet" href="dashboard.css">
  <link rel="stylesheet" href="styles/split-pane.css">
  <link rel="stylesheet" href="styles/utilities/loading-states.css">
  <link rel="stylesheet" href="styles/utilities/layout.css">
  <link rel="stylesheet" href="styles/utilities/components.css">
  
  <!-- View-specific Styles (load asynchronously) -->
  <link rel="preload" href="views/activity/styles.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
  <noscript>
    <link rel="stylesheet" href="views/activity/styles.css">
  </noscript>
  <link rel="preload" href="views/activity/storyboard-styles.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
  <noscript>
    <link rel="stylesheet" href="views/activity/storyboard-styles.css">
  </noscript>
  
  <!-- Non-critical CSS (defer) -->
  <link rel="stylesheet" href="views/navigator/styles.css" media="print" onload="this.media='all'">
  <link rel="stylesheet" href="views/analytics/styles.css" media="print" onload="this.media='all'">
  <link rel="stylesheet" href="views/whiteboard/styles.css" media="print" onload="this.media='all'">
  <link rel="stylesheet" href="views/system/styles.css" media="print" onload="this.media='all'">
  <link rel="stylesheet" href="views/file-graph/styles.css" media="print" onload="this.media='all'">
  <link rel="stylesheet" href="views/schema-config/styles.css" media="print" onload="this.media='all'">
  <link rel="stylesheet" href="views/workspace-comparison/styles.css" media="print" onload="this.media='all'">
  <link rel="stylesheet" href="views/activity/context-visualization.css" media="print" onload="this.media='all'">
  <link rel="stylesheet" href="views/activity/status-message-visualization.css" media="print" onload="this.media='all'">
      <link rel="stylesheet" href="views/clio/styles.css" media="print" onload="this.media='all'">
      <link rel="stylesheet" href="views/module-graph/styles.css" media="print" onload="this.media='all'">
      <link rel="stylesheet" href="views/rung1-tokens/styles.css" media="print" onload="this.media='all'">
      <link rel="stylesheet" href="views/rung2-edit-scripts/styles.css" media="print" onload="this.media='all'">
      <link rel="stylesheet" href="views/rung3-functions/styles.css" media="print" onload="this.media='all'">
      <link rel="stylesheet" href="views/historical-mining/styles.css" media="print" onload="this.media='all'">
  <link rel="stylesheet" href="components/db-preview.css" media="print" onload="this.media='all'">
  
  <!-- Service Worker Registration -->
  <script>
    // Option to disable ServiceWorker if causing CORS issues
    // Set to true to disable (useful for debugging OpaqueResponseBlocking errors)
    const DISABLE_SERVICE_WORKER = true;
    
    // Prevent multiple registrations
    if (!window._serviceWorkerRegistered && !DISABLE_SERVICE_WORKER && 'serviceWorker' in navigator) {
      window._serviceWorkerRegistered = true;
      
      window.addEventListener('load', () => {
        // Only register if we're on HTTP/HTTPS
        if (window.location.protocol === 'http:' || window.location.protocol === 'https:') {
          // Check for existing registration first
          navigator.serviceWorker.getRegistration().then(existingReg => {
            if (existingReg) {
              console.log('[SW] Already registered:', existingReg.scope);
              // Only listen for updates, don't reload immediately
              existingReg.addEventListener('updatefound', () => {
                const newWorker = existingReg.installing;
                if (newWorker) {
                  newWorker.addEventListener('statechange', () => {
                    if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                      // New service worker available, but don't auto-reload
                      console.log('[SW] New service worker available. Refresh to update.');
                    }
                  });
                }
              });
            } else {
              // Register new service worker
              navigator.serviceWorker.register('/sw.js')
                .then(reg => {
                  console.log('[SW] Registered:', reg.scope);
                  // Listen for updates but don't auto-reload
                  reg.addEventListener('updatefound', () => {
                    const newWorker = reg.installing;
                    if (newWorker) {
                      newWorker.addEventListener('statechange', () => {
                        if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                          console.log('[SW] New service worker available. Refresh to update.');
                        }
                      });
                    }
                  });
                })
                .catch(err => {
                  console.warn('[SW] Registration failed:', err);
                  window._serviceWorkerRegistered = false; // Allow retry
                });
            }
          }).catch(err => {
            console.warn('[SW] Error checking registration:', err);
            window._serviceWorkerRegistered = false;
          });
        } else {
          console.warn('[SW] Service worker requires HTTP server. Access dashboard at http://localhost:43917/dashboard.html');
        }
      });
    } else if (DISABLE_SERVICE_WORKER) {
      console.log('[SW] ServiceWorker disabled (DISABLE_SERVICE_WORKER = true)');
      // Unregister any existing service workers
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.getRegistrations().then(registrations => {
          registrations.forEach(registration => registration.unregister());
        });
      }
    }
  </script>
</head>
<body>
  <!-- Skip to main content link for accessibility -->
  <a href="#main-content" class="skip-link">Skip to main content</a>
  
  <!-- Main App Container -->
  <div id="app" class="app-container">
    
    <!-- Mobile Menu Toggle -->
    <button class="mobile-menu-toggle" id="mobileMenuToggle" aria-label="Toggle menu">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M3 12h18M3 6h18M3 18h18"/>
      </svg>
    </button>
    
    <!-- Sidebar Overlay (Mobile) -->
    <div class="sidebar-overlay" id="sidebarOverlay"></div>
    
    <!-- Mobile Menu Toggle Script -->
    <script>
      (function() {
        const mobileMenuToggle = document.getElementById('mobileMenuToggle');
        const sidebar = document.querySelector('.sidebar');
        const sidebarOverlay = document.getElementById('sidebarOverlay');
        
        function toggleSidebar() {
          if (sidebar) {
            sidebar.classList.toggle('open');
          }
          if (sidebarOverlay) {
            sidebarOverlay.classList.toggle('active');
          }
          document.body.style.overflow = sidebar && sidebar.classList.contains('open') ? 'hidden' : '';
        }
        
        function closeSidebar() {
          if (sidebar) {
            sidebar.classList.remove('open');
          }
          if (sidebarOverlay) {
            sidebarOverlay.classList.remove('active');
          }
          document.body.style.overflow = '';
        }
        
        if (mobileMenuToggle) {
          mobileMenuToggle.addEventListener('click', toggleSidebar);
        }
        
        if (sidebarOverlay) {
          sidebarOverlay.addEventListener('click', closeSidebar);
        }
        
        // Close sidebar when clicking a nav link on mobile
        const navLinks = document.querySelectorAll('.nav-link');
        navLinks.forEach(link => {
          link.addEventListener('click', () => {
            if (window.innerWidth <= 768) {
              closeSidebar();
            }
          });
        });
        
        // Close sidebar on window resize if it becomes desktop size
        window.addEventListener('resize', () => {
          if (window.innerWidth > 768) {
            closeSidebar();
          }
        });
      })();
    </script>
    
    <!-- Status Popup -->
    <div id="statusPopup" class="status-popup">
      <div class="status-popup-header">
        <span class="status-popup-title">[LAUNCH] Dashboard Status</span>
        <button class="status-popup-close" onclick="closeStatusPopup()">×</button>
      </div>
      <div class="status-popup-content" id="statusPopupContent">
        <div class="status-message">Initializing...</div>
      </div>
    </div>

    <!-- Sidebar Navigation -->
    <aside class="sidebar">
      <div class="sidebar-header">
        <div class="logo">
          <span>Cursor Telemetry</span>
        </div>
        <button class="search-trigger" onclick="if(window.openSearchPalette) window.openSearchPalette(); else console.warn('Search not loaded yet');" title="Search (Cmd+K)">
          <svg width="18" height="18" viewBox="0 0 20 20" fill="none" stroke="currentColor">
            <circle cx="8" cy="8" r="6" stroke-width="2"/>
            <path d="M13 13l4 4" stroke-width="2" stroke-linecap="round"/>
          </svg>
          <kbd class="search-trigger-kbd">⌘K</kbd>
        </button>
      </div>

      <div style="padding: 0 var(--space-lg); margin-top: var(--space-sm); margin-bottom: var(--space-md);">
        <div class="connection-status" id="connectionStatus">
          <div class="connection-status-row">
            <span class="status-dot"></span>
            <span class="status-text">Connecting...</span>
            <button class="connection-retry-btn" id="connectionRetryBtn" onclick="testConnection()" title="Retry connection to companion service">Retry</button>
          </div>
          <div class="connection-progress" id="connectionProgress">
            <div class="connection-progress-bar" id="connectionProgressBar" style="width: 0%"></div>
          </div>
        </div>
      </div>

      <nav class="sidebar-nav">
        <!-- General Views Section -->
        <div class="nav-section">
          <div class="nav-section-header">
            <span class="nav-section-title">General Views</span>
          </div>
          <div class="nav-section-links">
            <a href="#overview" class="nav-link active" data-view="overview">
              <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
                <path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z"/>
              </svg>
              <span>Overview</span>
            </a>
            <a href="#activity" class="nav-link" data-view="activity">
              <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z"/>
              </svg>
              <span>Activity</span>
            </a>
            
            <a href="#analytics" class="nav-link" data-view="analytics">
              <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
                <path d="M2 11a1 1 0 011-1h2a1 1 0 011 1v5a1 1 0 01-1 1H3a1 1 0 01-1-1v-5zM8 7a1 1 0 011-1h2a1 1 0 011 1v9a1 1 0 01-1 1H9a1 1 0 01-1-1V7zM14 4a1 1 0 011-1h2a1 1 0 011 1v12a1 1 0 01-1 1h-2a1 1 0 01-1-1V4z"/>
              </svg>
              <span>Analytics</span>
            </a>
            
            <a href="#whiteboard" class="nav-link" data-view="whiteboard">
              <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4zm2 6a1 1 0 011-1h6a1 1 0 110 2H7a1 1 0 01-1-1zm1 3a1 1 0 100 2h6a1 1 0 100-2H7z" clip-rule="evenodd"/>
              </svg>
              <span>Whiteboard</span>
            </a>
            
            <a href="#filegraph" class="nav-link" data-view="filegraph">
              <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
                <path d="M10 3.5a1.5 1.5 0 013 0V4a1 1 0 001 1h3a1 1 0 011 1v3a1 1 0 01-1 1h-.5a1.5 1.5 0 000 3h.5a1 1 0 011 1v3a1 1 0 01-1 1h-3a1 1 0 01-1-1v-.5a1.5 1.5 0 00-3 0v.5a1 1 0 01-1 1H6a1 1 0 01-1-1v-3a1 1 0 00-1-1h-.5a1.5 1.5 0 010-3H4a1 1 0 001-1V6a1 1 0 011-1h3a1 1 0 001-1v-.5z"/>
              </svg>
              <span>File Graph</span>
            </a>

            <a href="#navigator" class="nav-link" data-view="navigator">
              <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd"/>
              </svg>
              <span>Navigator</span>
            </a>
            
            <a href="#system" class="nav-link" data-view="system">
              <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M11.49 3.17c-.38-1.56-2.6-1.56-2.98 0a1.532 1.532 0 01-2.286.948c-1.372-.836-2.942.734-2.106 2.106.54.886.061 2.042-.947 2.287-1.561.379-1.561 2.6 0 2.978a1.532 1.532 0 01.947 2.287c-.836 1.372.734 2.942 2.106 2.106a1.532 1.532 0 012.287.947c.379 1.561 2.6 1.561 2.978 0a1.533 1.533 0 012.287-.947c1.372.836 2.942-.734 2.106-2.106a1.533 1.533 0 01.947-2.287c1.561-.379 1.561-2.6 0-2.978a1.532 1.532 0 01-.947-2.287c.836-1.372-.734-2.942-2.106-2.106a1.532 1.532 0 01-2.287-.947zM10 13a3 3 0 100-6 3 3 0 000 6z"/>
              </svg>
              <span>System</span>
            </a>
            
            <a href="#workspace-comparison" class="nav-link" data-view="workspace-comparison">
              <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
                <path d="M8 3H5a2 2 0 00-2 2v3m18 0V5a2 2 0 00-2-2h-3m0 18h3a2 2 0 002-2v-3M3 16v3a2 2 0 002 2h3"/>
              </svg>
              <span>Compare</span>
            </a>
            
            <a href="#schema-config" class="nav-link" data-view="schema-config">
              <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M11.49 3.17c-.38-1.56-2.6-1.56-2.98 0a1.532 1.532 0 01-2.286.948c-1.372-.836-2.942.734-2.106 2.106.54.886.061 2.042-.947 2.287-1.561.379-1.561 2.6 0 2.978a1.532 1.532 0 01.947 2.287c-.836 1.372.734 2.942 2.106 2.106a1.532 1.532 0 012.287.947c.379 1.561 2.6 1.561 2.978 0a1.533 1.533 0 012.287-.947c1.372.836 2.942-.734 2.106-2.106a1.533 1.533 0 01.947-2.287c1.561-.379 1.561-2.6 0-2.978a1.532 1.532 0 01-.947-2.287c.836-1.372-.734-2.942-2.106-2.106a1.532 1.532 0 01-2.287-.947zM10 13a3 3 0 100-6 3 3 0 000 6z"/>
              </svg>
              <span>Schema Config</span>
            </a>
            
            <a href="#api-docs" class="nav-link" data-view="api-docs">
              <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
                <path d="M9 4.804A7.968 7.968 0 005.5 4c-1.255 0-2.443.29-3.5.804v10A7.969 7.969 0 015.5 14c1.669 0 3.218.51 4.5 1.385A7.962 7.962 0 0114.5 14c1.255 0 2.443.29 3.5.804v-10A7.968 7.968 0 0014.5 4c-1.255 0-2.443.29-3.5.804V12a1 1 0 11-2 0V4.804z"/>
              </svg>
              <span>API Docs</span>
            </a>
          </div>
        </div>

        <!-- Procedural Knowledge Section -->
        <div class="nav-section">
          <div class="nav-section-header">
            <span class="nav-section-title">Procedural Knowledge</span>
          </div>
          <div class="nav-section-links">
            <a href="#patterns-history" class="nav-link" data-view="patterns-history">
              <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd"/>
              </svg>
              <span>Patterns History</span>
            </a>
            <!-- Ordered by Privacy Tier: Highest Privacy → Lowest Privacy -->
            <a href="#clio" class="nav-link" data-view="clio" title="Highest Privacy, Lowest Expressiveness - Recurring workflow patterns">
              <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M3 3a1 1 0 000 2v8a2 2 0 002 2h2.586l-1.293 1.293a1 1 0 101.414 1.414L10 15.414l2.293 2.293a1 1 0 001.414-1.414L12.414 15H15a2 2 0 002-2V5a1 1 0 100-2H3zm11.707 4.707a1 1 0 00-1.414-1.414L10 9.586 8.707 8.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
              </svg>
              <span>Clio (Motifs)</span>
            </a>
            <a href="#module-graph" class="nav-link" data-view="module-graph" title="High Privacy, Low Expressiveness - File relationships and dependencies">
              <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M3 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" clip-rule="evenodd"/>
              </svg>
              <span>Module Graph</span>
            </a>
            <a href="#rung3-functions" class="nav-link" data-view="rung3-functions" title="Medium Privacy, Medium Expressiveness - Function-level changes and call graphs">
              <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd"/>
              </svg>
              <span>Functions</span>
            </a>
            <a href="#rung2-edit-scripts" class="nav-link" data-view="rung2-edit-scripts" title="Low Privacy, High Expressiveness - Statement-level semantic edit scripts">
              <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4zm2 6a1 1 0 011-1h6a1 1 0 110 2H7a1 1 0 01-1-1zm1 3a1 1 0 100 2h6a1 1 0 100-2H7z" clip-rule="evenodd"/>
              </svg>
              <span>Edit Scripts</span>
            </a>
            <a href="#rung1-tokens" class="nav-link" data-view="rung1-tokens" title="Lowest Privacy, Highest Expressiveness - Token-level sequences with canonicalized identifiers">
              <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M3 3a1 1 0 000 2v8a2 2 0 002 2h2.586l-1.293 1.293a1 1 0 101.414 1.414L10 15.414l2.293 2.293a1 1 0 001.414-1.414L12.414 15H15a2 2 0 002-2V5a1 1 0 100-2H3zm11.707 4.707a1 1 0 00-1.414-1.414L10 9.586 8.707 8.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
              </svg>
              <span>Tokens</span>
            </a>
            <a href="#historical-mining" class="nav-link" data-view="historical-mining" title="Mine historical development data from git, shell, and logs">
              <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z" clip-rule="evenodd"/>
              </svg>
              <span>Historical Mining</span>
            </a>
          </div>
        </div>
      </nav>

      <div class="sidebar-footer">
        <div class="workspace-selector">
          <label>Workspace</label>
          <select id="workspaceSelect" class="select-input">
            <option value="all">All Workspaces</option>
          </select>
        </div>
        
        <button class="export-btn" onclick="showExportOptionsModal()" title="Export database with custom options (date range, types, filters)">
          <svg width="18" height="18" viewBox="0 0 20 20" fill="currentColor">
            <path d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z"/>
          </svg>
          <span>Export JSON</span>
        </button>
        <button class="export-btn" onclick="if(window.showShareModal) window.showShareModal(); else console.warn('Sharing handler not loaded');" title="Share workspace data with others via secure, time-limited links. Create shareable links that allow others to view your workspace analytics, activity patterns, and metrics. You can control privacy levels, set expiration dates, and filter by date ranges. Perfect for sharing progress with teammates, collaborating on projects, or showcasing your development workflow.">
          <svg width="18" height="18" viewBox="0 0 20 20" fill="currentColor">
            <path d="M15 8a3 3 0 10-2.977-2.63l-4.94 2.47a3 3 0 100 4.319l4.94 2.47a3 3 0 10.895-1.789l-4.94-2.47a3.027 3.027 0 000-.74l4.94-2.47C13.456 7.68 14.19 8 15 8z"/>
          </svg>
          <span>Share Workspace</span>
        </button>
        <button class="export-btn" onclick="if(window.showImportModal) window.showImportModal(); else console.warn('Import handler not loaded');" title="Open a shared workspace or import workspace data">
          <svg width="18" height="18" viewBox="0 0 20 20" fill="currentColor">
            <path d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" transform="rotate(180 10 10)"/>
          </svg>
          <span>Open Shared Workspace</span>
        </button>
      </div>
    </aside>

    <!-- Main Content -->
    <main id="main-content" class="main-content" role="main" aria-label="Main content">
      <!-- Header Stats -->
      <header class="dashboard-header">
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-content">
              <span class="stat-label" title="Total number of workspaces tracked across all projects">Total Workspaces</span>
              <span class="stat-value" id="statWorkspaces">0</span>
            </div>
          </div>
          <div class="stat-card">
            <div class="stat-content">
              <span class="stat-label" title="Unique coding sessions detected">Active Sessions</span>
              <span class="stat-value" id="statSessions">0</span>
            </div>
          </div>
          <div class="stat-card">
            <div class="stat-content">
              <span class="stat-label" title="Total number of file modification events tracked. Each time you edit, save, or modify a file, it counts as one file change. Includes: code changes (additions/deletions), file saves, and other file-related activities captured by the companion service's file watcher. This metric represents your total tracked file modifications since data collection began.">File Changes</span>
              <span class="stat-value" id="statFileChanges">0</span>
            </div>
          </div>
          <div class="stat-card">
            <div class="stat-content">
              <span class="stat-label" title="Prompts with meaningful content (>5 chars). Includes: Cursor chat, Composer, manual capture, clipboard. Excludes: empty prompts, JSON metadata, system messages. Checks all text fields: text, prompt, preview, content, message.">AI Interactions</span>
              <span class="stat-value" id="statAIInteractions">0</span>
            </div>
          </div>
          <div class="stat-card">
            <div class="stat-content">
              <span class="stat-label" title="Total code added + deleted (all-time)">Code Changed</span>
              <span class="stat-value" id="statCodeChanged">0 KB</span>
            </div>
          </div>
          <div class="stat-card">
            <div class="stat-content">
              <span class="stat-label" title="Average AI context window utilization">Avg Context Used</span>
              <span class="stat-value" id="statAvgContext">0%</span>
            </div>
          </div>
          <div class="stat-card">
            <div class="stat-content">
              <span class="stat-label" title="Top programming languages by file changes">Languages</span>
              <span class="stat-value" id="statLanguages">-</span>
            </div>
          </div>
          <div class="stat-card">
            <div class="stat-content">
              <span class="stat-label" title="Most active workspace">Active Workspace</span>
              <span class="stat-value" id="statActiveWorkspace">-</span>
            </div>
          </div>
          <div class="stat-card">
            <div class="stat-content">
              <span class="stat-label" title="Total activities today (file changes + AI prompts)">Activities Today</span>
              <span class="stat-value" id="statActivitiesToday">0</span>
              <span class="stat-hint" id="statActivitiesTodayBreakdown" style="font-size: 0.75rem; color: var(--color-text-muted, #666); margin-top: 0.25rem; display: block;">-</span>
            </div>
          </div>
        </div>
      </header>

      <!-- View Container -->
      <div id="viewContainer" class="view-container">
        <!-- Views will be rendered here -->
      </div>
    </main>
  </div>

  <!-- Event Modal -->
  <div id="eventModal" class="modal">
    <div class="modal-overlay"></div>
    <div class="modal-content modal-large">
      <div class="modal-header">
        <h2 id="modalTitle">Event Details</h2>
        <button class="modal-close" onclick="closeEventModal()">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <path d="M18 6L6 18M6 6l12 12" stroke-width="2" stroke-linecap="round"/>
          </svg>
        </button>
      </div>
      <div class="modal-body" id="modalBody">
        <!-- Modal content -->
      </div>
    </div>
  </div>

  <!-- Thread Modal -->
  <div id="threadModal" class="modal">
    <div class="modal-overlay"></div>
    <div class="modal-content modal-large">
      <div class="modal-header">
        <h2 id="threadModalTitle">Thread Details</h2>
        <button class="modal-close" onclick="closeThreadModal()">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <path d="M18 6L6 18M6 6l12 12" stroke-width="2" stroke-linecap="round"/>
          </svg>
        </button>
      </div>
      <div class="modal-body" id="threadModalBody">
        <!-- Thread content -->
      </div>
    </div>
  </div>

  <!-- Search Command Palette -->
  <div id="searchPalette" class="search-palette">
    <div class="search-palette-overlay" onclick="closeSearchPalette()"></div>
    <div class="search-palette-content">
      <div class="search-palette-header">
        <div class="search-header-top">
          <div class="search-input-wrapper">
            <svg class="search-icon" width="20" height="20" viewBox="0 0 20 20" fill="none" stroke="currentColor">
              <circle cx="8" cy="8" r="6" stroke-width="2"/>
              <path d="M13 13l4 4" stroke-width="2" stroke-linecap="round"/>
            </svg>
            <input 
              type="text" 
              id="searchInput" 
              class="search-input" 
              placeholder="Search events, prompts, files, or ask questions..."
              autocomplete="off"
              spellcheck="false"
              oninput="if(window.updateClearButton) window.updateClearButton(); if(window.updateSearchExamples) window.updateSearchExamples();"
            />
            <button id="clearSearchBtn" class="search-clear-btn" onclick="clearSearchInput()" style="display: none;" title="Clear search">
              <svg width="16" height="16" viewBox="0 0 16 16" fill="none" stroke="currentColor">
                <path d="M12 4L4 12M4 4l8 8" stroke-width="2" stroke-linecap="round"/>
              </svg>
            </button>
            <div id="searchSemanticStatus" class="search-semantic-status" style="display: none;" title="Hugging Face semantic search enabled">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <path d="M12 2L2 7l10 5 10-5-10-5z" stroke-width="2"/>
                <path d="M2 17l10 5 10-5M2 12l10 5 10-5" stroke-width="2"/>
              </svg>
              <span>AI</span>
            </div>
            <kbd class="search-kbd">esc</kbd>
          </div>
        </div>
        <!-- Quick Filter Chips -->
        <div class="search-quick-filters" id="searchQuickFilters">
          <button class="filter-chip" data-filter="type:prompt" onclick="applyQuickFilter('type:prompt')" title="Filter by prompts">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
            </svg>
            Prompts
          </button>
          <button class="filter-chip" data-filter="type:event" onclick="applyQuickFilter('type:event')" title="Filter by events">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
              <polyline points="14 2 14 8 20 8"/>
              <line x1="16" y1="13" x2="8" y2="13"/>
              <line x1="16" y1="17" x2="8" y2="17"/>
              <polyline points="10 9 9 9 8 9"/>
            </svg>
            Events
          </button>
          <button class="filter-chip" data-filter="type:terminal" onclick="applyQuickFilter('type:terminal')" title="Filter by terminal commands">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <polyline points="4 17 10 11 4 5"/>
              <line x1="12" y1="19" x2="20" y2="19"/>
            </svg>
            Terminal
          </button>
          <button class="filter-chip" data-filter="date:today" onclick="applyQuickFilter('date:today')" title="Filter by today">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
              <line x1="16" y1="2" x2="16" y2="6"/>
              <line x1="8" y1="2" x2="8" y2="6"/>
              <line x1="3" y1="10" x2="21" y2="10"/>
            </svg>
            Today
          </button>
          <button class="filter-chip" data-filter="date:week" onclick="applyQuickFilter('date:week')" title="Filter by this week">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
              <line x1="16" y1="2" x2="16" y2="6"/>
              <line x1="8" y1="2" x2="8" y2="6"/>
              <line x1="3" y1="10" x2="21" y2="10"/>
            </svg>
            This Week
          </button>
        </div>
        <!-- Recent Searches -->
        <div id="recentSearches" class="recent-searches" style="display: none;">
          <div class="recent-searches-header">
            <span>Recent Searches</span>
            <button class="clear-recent-btn" onclick="clearRecentSearches()" title="Clear recent searches">Clear</button>
          </div>
          <div id="recentSearchesList" class="recent-searches-list"></div>
        </div>
      </div>
      <div class="search-palette-body">
        <!-- Loading State -->
        <div id="searchLoading" class="search-loading" style="display: none;">
          <div class="search-loading-spinner"></div>
          <span>Searching...</span>
        </div>
        <!-- Results -->
        <div id="searchResults" class="search-results">
          <!-- Results will be rendered here -->
        </div>
        <!-- Suggestions/Examples -->
        <div id="searchSuggestions" class="search-suggestions">
          <div id="searchExamples" class="search-examples" style="display: none;">
            <div class="search-examples-section">
              <div class="search-examples-header">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display: inline-block; vertical-align: middle;">
                  <path d="M15 14c.2-1 .7-1.7 1.5-2.5 1-.9 1.5-2.2 1.5-3.5A6 6 0 0 0 6 8c0 1 .2 2.2 1.5 3.5.7.7 1.3 1.5 1.5 2.5"/>
                  <path d="M9 18h6"/>
                  <path d="M10 22h4"/>
                </svg>
                <span>Try asking:</span>
              </div>
              <div class="search-examples-grid">
                <button class="search-example" onclick="if(window.setSearchQuery) window.setSearchQuery('What files did I modify when fixing bugs?')">
                  <span class="example-icon">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <path d="m8 2 1.88 1.88"/>
                      <path d="M14.12 3.88 16 2"/>
                      <path d="M9 7.13v-1a3.003 3.003 0 1 1 6 0v1"/>
                      <path d="M12 20c-3.3 0-6-2.7-6-6v-3a4 4 0 0 1 4-4h4a4 4 0 0 1 4 4v3c0 3.3-2.7 6-6 6Z"/>
                      <path d="M12 20v-9"/>
                      <path d="M6.53 9C4.6 8.8 3 7.1 3 5"/>
                      <path d="M6 13H2"/>
                      <path d="M3 21c0-2.1 1.7-3.9 3.8-4"/>
                      <path d="M20.97 5c0 2.1-1.6 3.8-3.5 4"/>
                      <path d="M18 13h4"/>
                      <path d="M17.2 17c2.1.1 3.8 1.9 3.8 4"/>
                    </svg>
                  </span>
                  <div>
                    <div class="example-title">Find bug fixes</div>
                    <div class="example-desc">What files did I modify when fixing bugs?</div>
                  </div>
                </button>
                <button class="search-example" onclick="if(window.setSearchQuery) window.setSearchQuery('Show me prompts about authentication')">
                  <span class="example-icon">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <rect width="18" height="11" x="3" y="11" rx="2" ry="2"/>
                      <path d="M7 11V7a5 5 0 0 1 10 0v4"/>
                    </svg>
                  </span>
                  <div>
                    <div class="example-title">Authentication prompts</div>
                    <div class="example-desc">Show me prompts about authentication</div>
                  </div>
                </button>
                <button class="search-example" onclick="if(window.setSearchQuery) window.setSearchQuery('Find code changes related to database queries')">
                  <span class="example-icon">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <ellipse cx="12" cy="5" rx="9" ry="3"/>
                      <path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"/>
                      <path d="M3 12c0 1.66 4 3 9 3s9-1.34 9-3"/>
                    </svg>
                  </span>
                  <div>
                    <div class="example-title">Database changes</div>
                    <div class="example-desc">Find code changes related to database queries</div>
                  </div>
                </button>
                <button class="search-example" onclick="if(window.setSearchQuery) window.setSearchQuery('What did I work on last week?')">
                  <span class="example-icon">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <path d="M8 2v4"/>
                      <path d="M16 2v4"/>
                      <rect width="18" height="18" x="3" y="4" rx="2"/>
                      <path d="M3 10h18"/>
                    </svg>
                  </span>
                  <div>
                    <div class="example-title">Recent work</div>
                    <div class="example-desc">What did I work on last week?</div>
                  </div>
                </button>
              </div>
            </div>
            <div class="search-examples-section">
              <div class="search-examples-header">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display: inline-block; vertical-align: middle;">
                  <polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/>
                </svg>
                <span>State Commands:</span>
              </div>
              <div class="search-examples-grid">
                <button class="search-example" onclick="if(window.setSearchQuery) window.setSearchQuery('Fork a state for trying a new authentication approach')">
                  <span class="example-icon">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <line x1="6" y1="3" x2="6" y2="15"/>
                      <circle cx="18" cy="6" r="3"/>
                      <circle cx="6" cy="18" r="3"/>
                      <path d="M18 9a9 9 0 0 1-9 9"/>
                    </svg>
                  </span>
                  <div>
                    <div class="example-title">Fork state</div>
                    <div class="example-desc">Fork a state for trying a new authentication approach</div>
                  </div>
                </button>
                <button class="search-example" onclick="if(window.setSearchQuery) window.setSearchQuery('Show me states where I was fixing the login bug')">
                  <span class="example-icon">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <circle cx="11" cy="11" r="8"/>
                      <path d="m21 21-4.35-4.35"/>
                    </svg>
                  </span>
                  <div>
                    <div class="example-title">Find states</div>
                    <div class="example-desc">Show me states where I was fixing the login bug</div>
                  </div>
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="search-palette-footer">
        <div class="search-footer-left">
          <div class="search-hint">
            <span><kbd>↑</kbd><kbd>↓</kbd> navigate</span>
            <span><kbd>↵</kbd> select</span>
            <span><kbd>esc</kbd> close</span>
            <span id="searchResultCount" style="display: none; margin-left: var(--space-md); font-weight: 500;"></span>
          </div>
        </div>
        <div class="search-footer-right">
          <div class="search-settings">
            <label class="search-setting-toggle" title="Enable Hugging Face AI semantic search (requires model download ~20MB)">
              <input type="checkbox" id="hfSemanticSearchToggle" onchange="toggleHuggingFaceSearch(this.checked)">
              <span class="toggle-label">AI Search</span>
              <span id="hfSearchStatus" class="hf-status-indicator"></span>
            </label>
          </div>
          <div class="search-filters-hint" title="Use filters: type:prompt, workspace:name, date:today, mode:chat">
            <svg width="14" height="14" viewBox="0 0 16 16" fill="none" stroke="currentColor">
              <path d="M2 4h12M4 8h8M6 12h4" stroke-width="2" stroke-linecap="round"/>
            </svg>
            <span>Filters</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Check if accessed via file:// and warn user
    if (window.location.protocol === 'file:') {
      console.warn('%cWARNING: Dashboard must be accessed via HTTP', 'color: #f59e0b; font-weight: bold; font-size: 14px;');
      console.warn('%cPlease access the dashboard at: http://localhost:43917/dashboard.html', 'color: #6366f1; font-size: 12px;');
      console.warn('ES modules, service workers, and fetch API require HTTP/HTTPS protocol.');
      
      // Show a visible warning in the page
      document.addEventListener('DOMContentLoaded', () => {
        const warning = document.createElement('div');
        warning.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; background: #fef3c7; border-bottom: 2px solid #f59e0b; padding: 12px; text-align: center; z-index: 10000; font-weight: 600;';
        warning.innerHTML = 'WARNING: Please access this dashboard via <a href="http://localhost:43917/dashboard.html" style="color: #6366f1; text-decoration: underline;">http://localhost:43917/dashboard.html</a> (not file://)';
        document.body.insertBefore(warning, document.body.firstChild);
      });
    }
  </script>
  
  <!-- External Libraries (async for non-blocking load) -->
  <script src="https://cdn.socket.io/4.5.4/socket.io.min.js" defer></script>
  <!-- Self-hosted Chart.js for offline support and faster loading -->
  <script src="lib/vendor/chart.min.js" defer></script>
  <!-- Self-hosted D3.js for offline support -->
  <script src="lib/vendor/d3.min.js"></script>
  <!-- Three.js ES Module (replaces deprecated build/three.min.js) -->
  <script type="module">
    (async function() {
      try {
        const THREE = await import('https://cdn.jsdelivr.net/npm/three@0.160.0/+esm');
        window.THREE = THREE.default || THREE;
        // Also load OrbitControls if needed
        if (typeof window.loadOrbitControls === 'undefined') {
          window.loadOrbitControls = async function() {
            if (!window.OrbitControls) {
              const { OrbitControls } = await import('https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/controls/OrbitControls.js');
              window.OrbitControls = OrbitControls;
            }
            return window.OrbitControls;
          };
        }
        console.log('[THREE] Three.js loaded successfully via ES modules');
      } catch (error) {
        console.error('[THREE] Failed to load Three.js:', error);
      }
    })();
  </script>
  <!-- OrbitControls loaded dynamically in navigator-3d-renderer.js if needed -->
  <!-- Self-hosted Lunr.js for offline support -->
  <script src="lib/vendor/lunr.min.js" defer></script>
  <script src="https://unpkg.com/lucide@latest" defer></script>
  
  <!-- Optimized Bundles - Load critical path first -->
  <script src="dist/loader.js"></script>
  
  <!-- Core Modules -->
  <!-- config.js, state.js, api-client.js already in critical.bundle.js (loaded by loader.js) -->
  <script src="core/view-helpers.js"></script>
  <script src="utils/performance/optimized-api-client.js"></script>
  <script src="core/websocket-manager.js"></script>
  
  <!-- Algorithm Modules (commented out - ES modules require HTTP, not file://) -->
  <!-- <script type="module" src="algorithms/similarity.js"></script> -->
  <!-- <script type="module" src="algorithms/dimensionality-reduction.js"></script> -->
  <!-- <script type="module" src="algorithms/clustering.js"></script> -->
  
  <!-- Modals (load early - needed by views, but can defer) -->
  <script src="modals/modal-manager.js" defer></script>
  <script src="app/landing-page-modal.js"></script>
  
  <!-- Utilities (load first - no dependencies, but can defer non-critical ones) -->
  <script src="utils/core/helpers.js"></script>
  <script src="utils/dom/dom-utils.js"></script>
  <script src="utils/ui/loading-states.js"></script>
  <script src="utils/files/file-helpers.js"></script>
  <script src="utils/math-helpers.js"></script>
  <script src="utils/ui/tooltip.js"></script>
  <script src="utils/data/data-helpers.js"></script>
  <!-- Performance optimizations (load early) -->
  <script src="utils/performance/debounce.js"></script>
  <script src="utils/api/request-deduplicator.js"></script>
  <script src="utils/api/batch-request-manager.js"></script>
  <script src="utils/compression/response-compression.js"></script>
  <script src="utils/workers/data-worker-helper.js"></script>
  <script src="utils/workers/analytics-worker-helper.js"></script>
  <script src="utils/formatting/time-formatting.js"></script>
  <script src="utils/events/event-helpers.js"></script>
  <script src="utils/timeline/temporal-threading.js" defer></script>
  <script src="utils/analysis/event-tagging.js" defer></script>
  <script src="utils/analysis/ast-parser.js" defer></script>
  <script src="utils/analysis/ast-visualizer.js" defer></script>
  <script src="utils/dom/templates.js"></script>
  <script src="utils/diff-viewer.js"></script>
  <script src="utils/modals/export-options-modal.js" defer></script>
  <script src="utils/validation/schema-validator.js" defer></script>
  <!-- lazy-loader.js already in critical.bundle.js -->
  <script src="utils/ui/lucide-icons.js" defer></script>
  
  <!-- Views (must load before view-router, defer non-critical) -->
        <script src="views/activity/activity-optimizer.js" defer></script>
        <script src="views/activity/context-visualization.js" defer></script>
        <script src="views/activity/status-message-visualization.js?v=2.3" defer></script>
        <!-- Timeline Helpers Modules (Phase 1 Refactoring) -->
        <!-- Load in order: grouping -> utils -> item renderers -> group renderers -> interactions -> main renderers -->
        <script src="views/activity/timeline-grouping.js" defer></script>
        <script src="views/activity/timeline-utils.js" defer></script>
        <script src="views/activity/timeline-item-renderers.js" defer></script>
        <script src="views/activity/timeline-group-renderers.js" defer></script>
        <script src="views/activity/timeline-interactions.js" defer></script>
        <script src="views/activity/timeline-renderers.js" defer></script>
        <!-- Legacy timeline-helpers.js kept for backward compatibility during migration -->
        <!-- <script src="views/activity/timeline-helpers.js" defer></script> -->
        <script src="views/activity/storyboard-timeline.js" defer></script>
        <script src="views/activity/search-handler.js" defer></script>
        <script src="views/activity/grouping-handler.js" defer></script>
  <script src="utils/timeline/commit-grouping.js" defer></script>
  <script src="utils/analysis/event-classifier.js" defer></script>
  <script src="utils/timeline/timeline-grouping.js" defer></script>
  <script src="views/activity/index.js" defer></script>
  <script src="views/threads/helpers.js" defer></script>
  <script src="views/threads/index.js" defer></script>
  <script src="views/overview/index.js" defer></script>
  <script src="views/analytics/chart-helpers.js" defer></script>
  <script src="views/analytics/model-usage-diagnostics.js" defer></script>
  <script src="views/analytics/index.js" defer></script>
  <script src="views/system/templates.js" defer></script>
  <script src="views/system/index.js" defer></script>
  <script src="views/file-graph/templates.js" defer></script>
  <script src="views/file-graph/tfidf-analyzer.js" defer></script>
  <script src="views/file-graph/embeddings-visualization.js" defer></script>
  <script src="views/file-graph/helpers.js" defer></script>
  <script src="views/file-graph/d3-renderer.js" defer></script>
  <script src="views/file-graph/file-graph.js" defer></script>
  <script src="views/schema-config/helpers.js" defer></script>
  <script src="views/schema-config/index.js" defer></script>
  <script src="views/file-graph/index.js" defer></script>
  <script src="views/workspace-comparison/index.js" defer></script>
  <script src="views/navigator/templates.js" defer></script>
  <script src="views/navigator/navigator-3d-renderer.js" defer></script>
  <!-- Performance Cache (load early for caching) -->
  <script src="utils/cache/performance-cache.js" defer></script>
  
  <!-- Enhanced Navigator Services (lazy load - only when navigator view is accessed) -->
  <script>
    // Lazy load navigator services only when needed
    window.loadNavigatorServices = function() {
      if (window._navigatorServicesLoaded) return Promise.resolve();
      window._navigatorServicesLoaded = true;
      
      return Promise.all([
        import('./services/navigator/code-embedding-service.js'),
        import('./services/navigator/umap-service.js'),
        import('./services/navigator/clustering-service.js'),
        import('./services/navigator/enhanced-cluster-labeling.js'),
        import('./services/navigator/semantic-search-service.js')
      ]).catch(() => {
        // Fallback to regular script loading if dynamic import fails
        const scripts = [
          'services/navigator/code-embedding-service.js',
          'services/navigator/umap-service.js',
          'services/navigator/clustering-service.js',
          'services/navigator/enhanced-cluster-labeling.js',
          'services/navigator/semantic-search-service.js'
        ];
        return Promise.all(scripts.map(src => {
          return new Promise((resolve) => {
            const script = document.createElement('script');
            script.src = src;
            script.defer = true;
            script.onload = resolve;
            script.onerror = resolve; // Continue even if one fails
            document.head.appendChild(script);
          });
        }));
      });
    };
  </script>
  <script src="views/navigator/navigator-layout.js" defer></script>
  <script src="views/navigator/navigator-renderer.js" defer></script>
  <script src="views/navigator/navigator-core.js" defer></script>
  <script src="views/navigator/index.js" defer></script>
  <script src="views/api-docs/templates.js" defer></script>
  <script src="views/api-docs/index.js" defer></script>
  <script src="views/todos/index.js" defer></script>
  <script src="views/whiteboard/query-executor.js" defer></script>
  <script src="views/whiteboard/visualization-engine.js" defer></script>
  <script src="views/whiteboard/ai-query-generator.js" defer></script>
  <script src="views/whiteboard/whiteboard-manager.js" defer></script>
  <script src="views/whiteboard/index.js" defer></script>
      <script src="views/clio/templates.js" defer></script>
      <script src="views/clio/procedural-clio.js" defer></script>
      <script src="views/clio/index.js" defer></script>
      <script src="views/module-graph/templates.js" defer></script>
      <script src="views/module-graph/module-graph-visualization.js" defer></script>
      <script src="views/module-graph/index.js" defer></script>
      <script src="views/rung1-tokens/templates.js" defer></script>
      <script src="views/rung1-tokens/index.js" defer></script>
      <script src="views/rung2-edit-scripts/templates.js" defer></script>
      <script src="views/rung2-edit-scripts/index.js" defer></script>
      <script src="views/rung3-functions/templates.js" defer></script>
      <script src="views/rung3-functions/index.js" defer></script>
      <script src="views/historical-mining/templates.js" defer></script>
      <script src="views/historical-mining/index.js" defer></script>
      <link rel="stylesheet" href="views/patterns-history/styles.css">
      <script src="views/patterns-history/index.js" defer></script>
  <!-- States feature disabled - scripts removed -->
  <!-- <script src="views/states/state-graph.js" defer></script> -->
  <!-- <script src="views/states/index.js" defer></script> -->
  
  <!-- View Router (loads after all views, defer since views are deferred) -->
  <script src="core/view-router.js" defer></script>
  
  <!-- Components (defer - not needed for initial render) -->
  <script src="components/panel-resizer.js" defer></script>
  <script src="components/charts/chart-utils.js" defer></script>
  <script src="components/account/account-modal.js" defer></script>
  <!-- Chart renderers (commented out - ES modules require HTTP, not file://) -->
  <!-- <script type="module" src="components/charts/chart-renderers.js"></script> -->
  <!-- <script type="module" src="components/charts/analytics-renderers.js"></script> -->
  <script src="components/charts/advanced-visualizations.js" defer></script>
  <script src="components/charts/file-metrics-visualizations.js" defer></script>
  <script src="components/db-preview.js" defer></script>
  <script src="components/split-pane-resizer.js" defer></script>
  
  <!-- Services: Data (defer - loaded after initial render) - Optimized -->
  <!-- persistent-storage.js, data-access-service.js, progressive-data-loader.js, optimized-initializer.js already in data-services.bundle.js -->
  <script src="services/data/companion-db-reader.js" defer></script>
  <script src="services/data/refresh-manager.js" defer></script>
  <script src="services/data/data-synchronizer.js" defer></script>
  <script src="utils/rendering/virtual-scroller.js" defer></script>
  
  <!-- Services: Account (defer - loaded after initial render) -->
  <script src="services/account/account-client.js" defer></script>
  <script src="app/account-button.js" defer></script>
  
  <!-- Services: Search (defer - not needed immediately) -->
  <script src="services/search/search-engine.js" defer></script>
  <script src="services/search/semantic-analysis-engine.js" defer></script>
  <script src="services/search/huggingface-semantic-search.js" defer></script>
  <script src="services/openrouter-embedding-service.js" defer></script>
  <script src="services/clustering/cluster-annotator.js" defer></script>
  <script src="services/annotation-service.js" defer></script>
  <script src="services/state-service.js" defer></script>
  <!-- States feature disabled - script removed -->
  
  <!-- Services: Analytics (defer - not needed for initial render) -->
  <script src="services/analytics/analytics-manager.js" defer></script>
  <script src="services/analytics/analytics-aggregator.js" defer></script>
  <script src="services/analytics/prompt-analytics-engine.js" defer></script>
  <script src="services/analytics/conversation-flow-analyzer.js" defer></script>
  <script src="services/conversation-hierarchy-builder.js" defer></script>
  
  <!-- App Modules (defer - loaded after core) -->
  <script src="app/progress-tracker.js" defer></script>
  <script src="app/status-popup.js"></script>
  <script src="app/status-popup-manager.js" defer></script>
  <script src="app/session-manager.js" defer></script>
  <script src="app/clipboard-watcher.js" defer></script>
  <script src="app/export-handler.js" defer></script>
  <script src="app/import-handler.js" defer></script>
  <script src="app/sharing-handler-v2.js" defer></script>
  <script src="app/search-handler.js" defer></script>
  <script src="app/ui-helpers.js" defer></script>
  <script src="app/data-initializer.js" defer></script>
  <script src="app/dashboard-initialization.js" defer></script>
  <script src="app/dashboard-lifecycle.js" defer></script>
  <script src="app/dashboard-search.js" defer></script>
  <script src="app/dashboard-export.js" defer></script>
  
  <!-- Utilities (defer - not critical for initial load) -->
  <script src="utils/computation/performance-optimizer.js" defer></script>
  <script src="utils/workers/web-worker-helper.js" defer></script>
  <script src="utils/storage/incremental-loader.js" defer></script>
  <script src="utils/storage/local-storage-helper.js" defer></script>
  <script src="app/dashboard-helpers.js" defer></script>
  <script src="utils/api/api-batcher.js" defer></script>
  <script src="utils/computation/computation-manager.js" defer></script>
  <script src="utils/ui/image-lazy-loader.js" defer></script>
  
  <!-- Background Services (load before dashboard.js, but can be async) -->
  <script src="services/background/view-state-manager.js"></script>
  <script src="services/background/background-sync-manager.js"></script>
  <script src="services/background/cross-tab-coordinator.js"></script>
  
  <!-- Config & Main Dashboard (must load last, synchronous) -->
  <!-- Environment config (loads first, can be generated at build time) -->
  <script src="config/config-env.js"></script>
  <script src="config/config.js"></script>
  <script src="dashboard.js"></script>
  
  <!-- Visualizations (defer - loaded on demand) -->
  <script src="visualizations/file-graph/file-graph-visualizer.js" defer></script>
  <script src="visualizations/time-series/time-series-visualizer.js" defer></script>
  
  <!-- Widgets (defer - not needed for initial render) -->
  <script src="widgets/prompt-display-system.js" defer></script>
</body>
</html>
